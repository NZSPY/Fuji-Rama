<!DOCTYPE html>
<html>
<head>
    <title>Game State View</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>

    <h2>Game State View</h2>
    <button onclick="window.location.href='index.html'" style="margin: 10px;">Return to Start</button>
<div id="tableContainer">/div>

  <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const tableId = urlParams.get('table') || 'default'; // Use 'default' as fallback
        const playerName = urlParams.get('player') || 'unknown'; // Use 'unknown' as fallback
        function fetchGameState() {
            fetch(`http://192.168.68.100:8080/state?table=${tableId}&player=${playerName}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayTable(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    const container = document.getElementById('tableContainer');
                    container.innerHTML = `<p style="color: red;">Error loading data: ${error.message}</p>`;
                });
        }

        function displayTable(data) {
            const container = document.getElementById('tableContainer');
            if (!data || typeof data !== 'object') {
                container.innerHTML = '<p style="color: red;">Invalid data received</p>';
                return;
            }
            
            let allTablesHtml = '';

            // Table 1: Table Cards
      
                const DrawDeck = Array.isArray(data.dd) ? data.dd.join(', ') : data.dd;
                allTablesHtml += `<table style="width: auto;">`;
                allTablesHtml += `<tr><th>Draw Deck (${DrawDeck})</th><th>Discard Pile</th></tr>`;
                if (DrawDeck > 0) {
                    allTablesHtml += `<tr><td><img src="LlamaCardBack.png" alt="Card Back" style="width:100px;"></td>`;
                } else {
                    allTablesHtml += `<tr><td><img src="NoLlamaCards.png" alt="Card Back" style="width:100px;"></td>`;
                }
               
                        const discardCards = Array.isArray(data.dp) ? data.dp : [data.dp];
                    discardCards.forEach(card => {
                    const cardValue = typeof card === 'object' ? card.Cardvalue : card;
                    allTablesHtml += `<td><img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:100px; margin:2px;"></td></tr>`;
                });
                const lastMovePlayed = Array.isArray(data.lmp)? data.lmp.join(', ') : data.lmp;

                allTablesHtml += `<tr><td colspan=2>${lastMovePlayed}</td></tr>`;
                allTablesHtml += '</table>';
     


            // Table 2: Player Hand and Valid Moves
            if (data.ph) {
                const playerName = Array.isArray(data.pn) ? data.pn.join(', ') : data.pn;
                const blackCounters = Array.isArray(data.pbc) ? data.pbc.join(', ') : data.pbc;
                const whiteCounters = Array.isArray(data.pwc) ? data.pwc.join(', ') : data.pwc;
                const score = (blackCounters*10) + whiteCounters;
                allTablesHtml += `<table style="width: auto;"><tr><th>${playerName} you have ${blackCounters} Black and ${whiteCounters} White Counters
                    <br> Score: ${score}
                    <br>and your current cards are </th></tr>`;
                let handHtml = '<td colspan="2">';
                if (Array.isArray(data.ph)) {
                    data.ph.forEach(card => {
                        const cardValue = typeof card === 'object' ? card.Cardvalue : card;
                        handHtml += `<img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:100px; margin:2px;">`;
                    });
                } else {
                    handHtml += data.ph || 'N/A';
                }
                handHtml += '</td>';
                allTablesHtml += `<tr>${handHtml}</tr>`;
                
                // Add valid moves in a new row
                allTablesHtml += '<tr><th  colspan="2">Valid Moves</th></tr>';
                const moves = Array.isArray(data.pvm) ? data.pvm.join(', ') : (data.pvm || 'n/a');
    allTablesHtml += `<tr><td>
        ${data.pls.find(p => p.n === playerName)?.s === 2 
            ? '<p>You have folded, Please wait for other players to finish</p>' 
            : data.pls.find(p => p.n === playerName)?.s === 0
            ? '<p>Please wait for other players have thier turn</p>'
            : data.pls.find(p => p.n === playerName)?.s === 1
            ? `${(moves.includes('C') || moves.includes('N') || moves.includes('D') || moves.includes('F'))
                ? `${moves.includes('C') ? '<button onclick="moveCurrent()">Play Current</button>' : ''}
                   ${moves.includes('N') ? '<button onclick="moveNext()">Play Next</button>' : ''}
                   ${moves.includes('D') ? '<button onclick="moveDraw()">Draw Card</button>' : ''}
                   ${moves.includes('F') ? '<button onclick="moveFold()">Fold</button>' : ''}`
                : ''}</td><TD><BR><B>Time remaining:</B> <div id="timer" style="font-size: 24px; color: #333;">30</div>`
            : '<p>The round is over</p>'
        }
    </td></tr>`;
    allTablesHtml += '</table>';
}


            // Table 3: List of other Players
            if (data.pls) {
                allTablesHtml += '<table style="width: auto;">';
                    const playerName = Array.isArray(data.pn) ? data.pn.join(', ') : data.pn;
                    const players = Array.isArray(data.pls) ? data.pls : [data.pls];
                players.forEach(player => {
                    // Skip if player name matches the query parameter
                    if (player.n === `${playerName}`) return;
                    const score = (player.bc*10) + player.wc;
                   const status =   player.s === 0 ? "Waiting" :
                                    player.s === 1 ? "Playing" :
                                    player.s === 2 ? "Folded" :
                                    player.s === 3 ? "Won the round" : "UNKNOWN";
                   allTablesHtml +=`<tr><th>${player.n} has ${player.bc} Black and ${player.wc} White Counters
                    <br> Score: ${score}
                    <br>and is  ${status}</th></tr>
                    <tr><td>${'<img src="LlamaCardBack.png" alt="Card Back" style="width:100px;">'.repeat(player.nc)}</td></tr>`;
                });
                allTablesHtml += '</table>';
            }
            container.innerHTML = allTablesHtml || '<p>No data available</p>';
        }
        
        function moveCurrent() {
            fetch('http://192.168.68.100:8080/move?table=' + tableId + '&player=' + playerName + "&VM=C")
            .then(response => {
                if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                fetchGameState(); // Refresh the game state
            })
            .catch(error => {
                console.error('Error making move:', error);
            });
        }

        function moveNext() {
            fetch('http://192.168.68.100:8080/move?table=' + tableId + '&player=' + playerName+ "&VM=N")
            .then(response => {
                if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                fetchGameState(); // Refresh the game state
            })
            .catch(error => {
                console.error('Error making move:', error);
            });
        }

        function moveDraw() {
            fetch('http://192.168.68.100:8080/move?table=' + tableId + '&player=' + playerName+ "&VM=D")
            .then(response => {
                if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                fetchGameState(); // Refresh the game state
            })
            .catch(error => {
                console.error('Error making move:', error);
            });
        }

        function moveFold() {
            fetch('http://192.168.68.100:8080/move?table=' + tableId + '&player=' + playerName+ "&VM=F")
            .then(response => {
                if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                fetchGameState(); // Refresh the game state
            })
            .catch(error => {
                console.error('Error making move:', error);
            });
        }


        // Fetch data when page loads
        fetchGameState();

   
        let timeLeft = 30;
        
        function updateTimer() {
            const timerElement = document.getElementById('timer');
            if (timerElement) {
                if (timeLeft > 0) {
                    timeLeft--;
                    timerElement.textContent = timeLeft;
                } else {
                    timeLeft = 30; // Reset timer
                }
            }
        }
        
        setInterval(updateTimer, 1000);
 

    // Keep track of the last data state
    let lastDataState = null;
    // Smooth refresh every second
    setInterval(async () => {
        try {
            const response = await fetch(`http://192.168.68.100:8080/state?table=${tableId}&player=${playerName}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            // Compare with last state
            if (JSON.stringify(data) !== JSON.stringify(lastDataState)) {
                displayTable(data);
                lastDataState = data;
                timeLeft = 30;
            // Check if round is over
            if (data.lmp && data.lmp.toString().substring(0, 4) === "(RE)") {
                window.location.href = 'Round_Over.html?table=' + tableId + '&player=' + playerName;
            }
        }
    } catch (error) {
        console.error('Error fetching data:', error);
    }
}, 1000);
    </script>
</body>
</html>        

