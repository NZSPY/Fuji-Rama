<!DOCTYPE html>
<html>
<head>
    <title>Game State View</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>

    <h2>Game State View</h2>
    <div id="tableContainer"></div>

    <script>
        function fetchGameState() {
            fetch('http://192.168.68.100:8080/state?table=ai1&player=Simon')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayTable(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    const container = document.getElementById('tableContainer');
                    container.innerHTML = `<p style="color: red;">Error loading data: ${error.message}</p>`;
                });
        }

        function displayTable(data) {
            const container = document.getElementById('tableContainer');
            if (!data || typeof data !== 'object') {
                container.innerHTML = '<p style="color: red;">Invalid data received</p>';
                return;
            }
            
            let allTablesHtml = '';

            // Table 1: Table Cards
      
                const DrawDeck = Array.isArray(data.dd) ? data.dd.join(', ') : data.dd;
                allTablesHtml += `<table style="width: auto;">`;
                allTablesHtml += `<tr><th>Draw Deck (${DrawDeck})</th><th>Discard Pile</th></tr>`;
                if (DrawDeck > 0) {
                    allTablesHtml += `<tr><td><img src="LlamaCardBack.png" alt="Card Back" style="width:100px;"></td>`;
                } else {
                    allTablesHtml += `<tr><td><img src="NoLlamaCards.png" alt="Card Back" style="width:100px;"></td>`;
                }
               
                        const discardCards = Array.isArray(data.dp) ? data.dp : [data.dp];
                    discardCards.forEach(card => {
                    const cardValue = typeof card === 'object' ? card.Cardvalue : card;
                    allTablesHtml += `<td><img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:100px; margin:2px;"></td></tr>`;
                });
                const lastMovePlayed = Array.isArray(data.lmp)? data.lmp.join(', ') : data.lmp;
                const waitTimer = Array.isArray(data.wt)? data.wt.join(', ') : data.wt;
                allTablesHtml += `<tr><td colspan=2>${lastMovePlayed} :${waitTimer}</td></tr>`;
                allTablesHtml += '</table>';
     


            // Table 2: Player Hand and Valid Moves
            if (data.ph) {
                const playerName = Array.isArray(data.pn) ? data.pn.join(', ') : data.pn;
                const blackCounters = Array.isArray(data.pbc) ? data.pbc.join(', ') : data.pbc;
                const whiteCounters = Array.isArray(data.pwc) ? data.pwc.join(', ') : data.pwc;
                const score = (blackCounters*10) + whiteCounters;
                allTablesHtml += `<table style="width: auto;"><tr><th>${playerName} you have ${blackCounters} Black and ${whiteCounters} White Counters
                    <br> Score: ${score}
                    <br>and your current cards are </th></tr>`;
                let handHtml = '<td>';
                if (Array.isArray(data.ph)) {
                    data.ph.forEach(card => {
                        const cardValue = typeof card === 'object' ? card.Cardvalue : card;
                        handHtml += `<img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:100px; margin:2px;">`;
                    });
                } else {
                    handHtml += data.ph || 'N/A';
                }
                handHtml += '</td>';
                allTablesHtml += `<tr>${handHtml}</tr>`;
                
                // Add valid moves in a new row
                allTablesHtml += '<tr><th>Valid Moves</th></tr>';
                const moves = Array.isArray(data.pvm) ? data.pvm.join(', ') : (data.pvm || 'N/A');
    allTablesHtml += `<tr><td>
        <button id="joinTableButton" onclick="moveCurrent()">Play Current</button>
        <button id="joinTableButton" onclick="moveNext()">Play Next</button>
        <button id="joinTableButton" onclick="moveDraw()">Draw Card</button>
        <button id="joinTableButton" onclick="moveFold()">Fold</button>
        <button onclick="location.reload()">Refresh</button>
    </td></tr>
   
    <tr><td>${moves}</td></tr>`;
    allTablesHtml += '</table>';
}


            // Table 3: List of other Players
            if (data.pls) {
                allTablesHtml += '<table style="width: auto;">';
                    const playerName = Array.isArray(data.pn) ? data.pn.join(', ') : data.pn;
                    const players = Array.isArray(data.pls) ? data.pls : [data.pls];
                players.forEach(player => {
                    // Skip if player name matches the query parameter
                    if (player.n === `${playerName}`) return;
                    const score = (player.bc*10) + player.wc;
                   const status =   player.s === 0 ? "Waiting" :
                                    player.s === 1 ? "Playing" :
                                    player.s === 2 ? "Folded" :
                                    player.s === 3 ? "Left the server" : "UNKNOWN";
                   allTablesHtml +=`<tr><th>${player.n} has ${player.bc} Black and ${player.wc} White Counters
                    <br> Score: ${score}
                    <br>and is  ${status}</th></tr>
                    <tr><td>${'<img src="LlamaCardBack.png" alt="Card Back" style="width:100px;">'.repeat(player.nc)}</td></tr>`;
                });
                allTablesHtml += '</table>';
            }
            container.innerHTML = allTablesHtml || '<p>No data available</p>';
        }
        
        function moveCurrent() {
            var tableId = "ai1"; // Hardcoded table ID for this example
            var playerName = "Simon"; // Hardcoded player name for this example
            window.open('http://192.168.68.100:8080/move?table=' + tableId + '&player=' + playerName + "&VM=C", '_blank');
            location.reload();
        }

        function moveNext() {
            var tableId = "ai1"; // Hardcoded table ID for this example
            var playerName = "Simon"; // Hardcoded player name for this example
            window.open('http://192.168.68.100:8080/move?table=' + tableId + '&player=' + playerName+ "&VM=N", '_blank');
            location.reload();
        }

        function moveDraw() {
            var tableId = "ai1"; // Hardcoded table ID for this example
            var playerName = "Simon"; // Hardcoded player name for this example
            window.open('http://192.168.68.100:8080/move?table=' + tableId + '&player=' + playerName+ "&VM=D", '_blank');
            location.reload();
        }

        function moveFold() {
            var tableId = "ai1"; // Hardcoded table ID for this example
            var playerName = "Simon"; // Hardcoded player name for this example
            window.open('http://192.168.68.100:8080/move?table=' + tableId + '&player=' + playerName+ "&VM=F", '_blank');
            location.reload();
        }


        // Fetch data when page loads
        fetchGameState();

        // Refresh every 5 seconds
       // setInterval(fetchGameState, 5000);
    </script>
</body>
</html>        

