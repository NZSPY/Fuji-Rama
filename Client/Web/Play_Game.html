<!DOCTYPE html>
<html>
<head>
    <title>Game State View</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>

    <h2>Game State View<button onclick="window.location.href='index.html'" style="margin: 10px;">Return to Table Selection</button></h2>
    
<div id="tableContainer"></div>

<script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const tableId = urlParams.get('table') || 'default'; // Use 'default' as fallback
    let playerName = urlParams.get('player') || 'unknown'; // Use 'unknown' as fallback
    function fetchGameState() {
        fetch(`https://fujillama.sypsoft.nz/state?table=${tableId}&player=${playerName}`)
        .then(response => {
            if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displayTable(data);
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            const container = document.getElementById('tableContainer');
            container.innerHTML = `<p style="color: red;">Error loading data: ${error.message}</p>`;
        });
    }

    let discardTop = null;  // Global variable for top discard card
    let discardNext = null;  // Global variable for top discard card

    function displayTable(data) {
        const container = document.getElementById('tableContainer');
        if (!data || typeof data !== 'object') {
        container.innerHTML = '<p style="color: red;">Invalid data received</p>';
        return;
        }
        

        // Initialize discard variables
        const discardCard = Array.isArray(data.dp) ? data.dp : [data.dp];
        const firstCard = discardCard[0];
        const cardValue = typeof firstCard === 'object' ? firstCard.cv : firstCard;
        discardTop = cardValue; // Update global variable with the top card
        discardNext = cardValue + 1; // Update global variable with the next card
        if (discardNext > 7) discardNext = 1; // Wrap around if needed


        let allTablesHtml = '';

        // Table 1 Combined for draw deck, player hand, and discard pile
       
        const currentPlayer = data.pls.find(p => p.n === playerName);
        const blackCounters = currentPlayer ? currentPlayer.bt : 0;
        const whiteCounters = currentPlayer ? currentPlayer.wt : 0;
        const moves = currentPlayer ? currentPlayer.pvm : [];
        const score = (blackCounters*10) + whiteCounters;
        const DrawDeck = Array.isArray(data.dd) ? data.dd.join(', ') : data.dd;
        

        allTablesHtml += `<table style="width: auto;">`;
        allTablesHtml += `<tr><th colspan="3">${playerName} you have ${blackCounters} Black and ${whiteCounters} White Tokens:  Score: ${score}</th></tr>`;
        
        // Row for cards
        allTablesHtml += '<tr>';
        // Draw deck
        allTablesHtml += `<td style="vertical-align: top; text-align: center;"><B>Draw Deck (${DrawDeck})</B><br>`;
        if (DrawDeck > 0) {
            if (moves.includes('D')) {
            allTablesHtml += `<button onclick="moveDraw()" style="border: dotted; background: none; padding: 0; cursor: pointer;">
                <img src="LlamaCardBack.png" alt="Card Back" style="width:100px;">
            </button>`;
            } else {
            allTablesHtml += `<img src="LlamaCardBack.png" alt="Card Back" style="width:100px;">`;
            }
        } else {
            allTablesHtml += `<img src="NoLlamaCards.png" alt="Card Back" style="width:100px;">`;
        }
        allTablesHtml += '</td>';

        // Player's hand
        allTablesHtml += '<td style="text-align: center;">Your Cards<br>';
        const isPlayingMove = moves.includes('1') || moves.includes('2') || moves.includes('3') || moves.includes('4') || moves.includes('5') || moves.includes('6') || moves.includes('7');
        const playerHand = currentPlayer ? currentPlayer.ph : '';
        if (playerHand) {
            playerHand.split('').forEach(cardValue => {
                if (isPlayingMove && (Number(cardValue) === Number(discardTop) || Number(cardValue) === Number(discardNext))) {
                    allTablesHtml += `<button onclick="playCard(${cardValue})" style="border: dotted; background: none; padding: 0; cursor: pointer;">
                        <img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:100px; margin:2px;">
                    </button>`;
                } else {
                    allTablesHtml += `<img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:100px; margin:2px;">`;
                }
            });
        }
        allTablesHtml += '</td>';

        // Discard pile
        allTablesHtml += '<td style="vertical-align: top; text-align: center;"><b>Discard Pile</b><br>';
        const discardCards = Array.isArray(data.dp) ? data.dp : [data.dp];
        discardCards.forEach(card => {
            const cardValue = typeof card === 'object' ? card.cv : card;
            if (moves.includes('F')) {
                allTablesHtml += `<button onclick="moveFold()" style="border: dotted; background: none; padding: 0; cursor: pointer;">
                    <img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:100px; margin:2px;">
                </button>`;
            } else {
                allTablesHtml += `<img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:100px; margin:2px;">`;
            }
        });
        allTablesHtml += '</td></tr>';

        // Valid moves
        allTablesHtml += `<tr>
            <td colspan="2">
            ${data.pls.find(p => p.n === playerName)?.s === 2 
            ? '<p>You have folded, Please wait for other players to finish</p>' 
            : data.pls.find(p => p.n === playerName)?.s === 0
            ? '<p>Please wait for other players have their turn</p>'
            : data.pls.find(p => p.n === playerName)?.s === 1
            ? `${moves.includes('D') ? '<span style="color: green;">Click on the draw deck to draw a card</br></span>' : ''}
               ${moves.includes('1') || moves.includes('2') || moves.includes('3') || moves.includes('4') || moves.includes('5') || moves.includes('6') || moves.includes('7') ? '<span style="color: Blue;">Click on a valid card in your hand to play it</br></span>' : ''}
               ${moves.includes('F') ? '<span style="color: red;">Click on the discard pile to fold</span>' : ''}` : ''}
            </td>
            <td>
            ${data.pls.find(p => p.n === playerName)?.s === 1 
            ? `<br /><b>Time remaining:</b> <div id="timer" style="font-size: 24px; color: #333;">60</div>(until auto fold)` 
            : ''}
            </td>
        </tr>`;

         // Last move played
         const lastMovePlayed = Array.isArray(data.lmp)? data.lmp.join(', ') : data.lmp;
        allTablesHtml += `<tr><td colspan="3">
            ${lastMovePlayed}
            ${lastMovePlayed === "Waiting for players to join" ? `<button onclick="startGame()" style="margin: 10px;">Start Game</button>` : ''}
        </td></tr>`;
        allTablesHtml += '</table>';
  //  }


            // Table 2: List of other Players
            if (data.pls) {
                allTablesHtml += '<table style="width: auto;">';
                // const playerName = Array.isArray(data.pn) ? data.pn.join(', ') : data.pn;
                const players = Array.isArray(data.pls) ? data.pls.filter(p => p.n !== playerName) : [];
                
                allTablesHtml += '<tr><th colspan="2" style="text-align: center;">Other Players at the table</th></tr>';
                
                // Create rows with 2 players per row
                for (let i = 0; i < Math.ceil(players.length / 2); i++) {
                    allTablesHtml += '<tr>';
                    
                    // First column (even index)
                    const player1 = players[i * 2];
                    if (player1) {
                        const score1 = (player1.bt * 10) + player1.wt;
                        const status1 = player1.s === 0 ? "Waiting" :
                                      player1.s === 1 ? "Playing" :
                                      player1.s === 2 ? "Folded" :
                                      player1.s === 3 ? "Won the round" : "UNKNOWN";
                        allTablesHtml += `
                            <td>
                                <div>${player1.n} has ${player1.bt} Black and ${player1.wt} White Counters</div>
                                <div>Score: ${score1} and is ${status1}</div>
                                <div>${'<img src="LlamaCardBack.png" alt="Card Back" style="width:75px;">'.repeat(player1.nc)}</div>
                            </td>`;
                    }
                    
                    // Second column (odd index)
                    const player2 = players[i * 2 + 1];
                    if (player2) {
                        const score2 = (player2.bt * 10) + player2.wt;
                        const status2 = player2.s === 0 ? "Waiting" :
                                      player2.s === 1 ? "Playing" :
                                      player2.s === 2 ? "Folded" :
                                      player2.s === 3 ? "Won the round" : "UNKNOWN";
                        allTablesHtml += `
                            <td>
                                <div>${player2.n} has ${player2.bt} Black and ${player2.wt} White Counters</div>
                                <div>Score: ${score2} and is ${status2}</div>
                                <div>${'<img src="LlamaCardBack.png" alt="Card Back" style="width:75px;">'.repeat(player2.nc)}</div>
                            </td>`;
                    } else {
                        allTablesHtml += '<td></td>';
                    }
                    
                    allTablesHtml += '</tr>';
                }
                allTablesHtml += '</table>';
            }
            container.innerHTML = allTablesHtml || '<p>No data available</p>';
        }
        
function playCard(cardclicked) {
    const card = cardclicked;
    

            fetch('https://fujillama.sypsoft.nz/move?table=' + tableId + '&player=' + playerName + "&VM="+cardclicked)
            .then(response => {
                if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                fetchGameState(); // Refresh the game state
            })
            .catch(error => {
                console.error('Error making move:', error);
            });
        }



        function moveDraw() {
            fetch('https://fujillama.sypsoft.nz/move?table=' + tableId + '&player=' + playerName+ "&VM=D")
            .then(response => {
                if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                fetchGameState(); // Refresh the game state
            })
            .catch(error => {
                console.error('Error making move:', error);
            });
        }

        function moveFold() {
            fetch('https://fujillama.sypsoft.nz/move?table=' + tableId + '&player=' + playerName+ "&VM=F")
            .then(response => {
                if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                fetchGameState(); // Refresh the game state
            })
            .catch(error => {
                console.error('Error making move:', error);
            });
        }

        function startGame() {
            fetch('https://fujillama.sypsoft.nz/start?table=' + tableId)
            .then(response => {
                if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                fetchGameState(); // Refresh the game state
            })
            .catch(error => {
                console.error('Error making move:', error);
            });
        }


        // Fetch data when page loads
        fetchGameState();

   
        let timeLeft = 60;
        
        function updateTimer() {
            const timerElement = document.getElementById('timer');
            if (timerElement) {
                if (timeLeft > 0) {
                    timeLeft--;
                    timerElement.textContent = timeLeft;
                } else {
                    timeLeft = 60; // Reset timer
                }
            }
        }
        
        setInterval(updateTimer, 1000);
 

    // Keep track of the last data state
    let lastDataState = null;
    // Smooth refresh every second
    setInterval(async () => {
        try {
            const response = await fetch(`https://fujillama.sypsoft.nz/state?table=${tableId}&player=${playerName}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            // Compare with last state
            if (JSON.stringify(data) !== JSON.stringify(lastDataState)) {
                displayTable(data);
                lastDataState = data;
                timeLeft = 60;
            // Check if round is over
            if (data.ts === 4) {
                window.location.href = 'Round_Over.html?table=' + tableId + '&player=' + playerName;
            }
        }
    } catch (error) {
        console.error('Error fetching data:', error);
    }
}, 1000);
    </script>
</body>
</html>        

