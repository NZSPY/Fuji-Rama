<!DOCTYPE html>
<html>
<head>
    <title>Game Results</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>

    <h2>Here are the results of the last round: 
        <button id="nextActionButton" style="margin: 10px;">Loading...</button>
    </h2>

    
    <div id="tableContainer"></div>
    
  <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const tableId = urlParams.get('table') || 'default'; // Use 'default' as fallback
        const playerName = urlParams.get('player') || 'unknown'; // Use 'unknown' as fallback
        function fetchGameState() {
            fetch(`http://192.168.68.100:8080/move?table=${tableId}&player=${playerName}&VM=R`)
            .then(response => {
                if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displayTable(data);
                // Second fetch after first one succeeds
                return fetch(`http://192.168.68.100:8080/state?table=${tableId}&player=${playerName}`);
            })
            .then(response => {
                if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displayTable(data);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                const container = document.getElementById('tableContainer');
                container.innerHTML = `<p style="color: red;">Error loading data: ${error.message}</p>`;
            });
        }


            function updateButton(msg1,msg2) {
            const button = document.getElementById('nextActionButton');
            if (msg2 != "") {
                button.onclick = () => window.location.href = 'index.html';
                button.textContent = 'Start a New Game';
            } else {
                button.onclick = () => window.location.href = 'Play_Game.html?table=' + tableId + '&player=' + playerName;
                button.textContent = 'Play Next Round';
            }
        }



        function displayTable(data) {
            const container = document.getElementById('tableContainer');
            if (!data || typeof data !== 'object') {
                container.innerHTML = '<p style="color: red;">Invalid data received</p>';
                return;
            }
            
            let allTablesHtml = '';


// List of Players and their scores
if (data.pls) {
    allTablesHtml += '<table style="width: auto;">';
    const players = Array.isArray(data.pls) ? data.pls : [data.pls];
    const message1 = Array.isArray(data.msg1) ? data.msg1 : [data.msg1];
    const message2 = Array.isArray(data.msg2) ? data.msg2 : [data.msg2];
    const message3 = Array.isArray(data.msg3) ? data.msg3 : [data.msg3];
   
   updateButton(message1,message2);
    
    allTablesHtml += '<table style="width: auto;">';
    // Find current player and other players
    const currentPlayer = players.find(p => p.n === playerName);
    const otherPlayers = players.filter(p => p.n !== playerName);
    const currentPlayerScore = currentPlayer ? (currentPlayer.bt * 10) + currentPlayer.wt : 0;
    // Show current player's info first
    if (currentPlayer) {
        allTablesHtml += `<tr><th colspan="2">${currentPlayer.n} has ${currentPlayer.bt} black tokens and ${currentPlayer.wt} white tokens, and a total score of ${currentPlayerScore}</th></tr>`;
        let handHtml = '<td colspan="2">';
        if  (currentPlayer.ph) {
            currentPlayer.ph.split('').forEach(cardValue => {
              
                handHtml += `<img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:100px; margin:2px;">`;
            });
        } else {
            handHtml += 'No cards';
        }
        handHtml += '</td>';
        allTablesHtml += `<tr>${handHtml}</tr>`;
       
    }
    allTablesHtml += '<tr><th colspan="2" style="text-align: center;">Other Players at the table</th></tr>';
    // Show other players in two columns
    for (let i = 0; i < otherPlayers.length; i += 2) {
        const player1 = otherPlayers[i];
        const player2 = otherPlayers[i + 1];
        const player1Score = (player1.bt * 10) + player1.wt;
        const player2Score = player2 ? (player2.bt * 10) + player2.wt : 0;
        // Player names
        allTablesHtml += '<tr>';
        allTablesHtml += `<td>${player1.n} has ${player1.bt} black tokens and ${player1.wt} white tokens, and a total score of ${player1Score}</td>`;
        allTablesHtml += player2 ? `<td>${player2.n} has ${player2.bt} black tokens and ${player2.wt} white tokens, and a total score of ${player2Score}</td>` : '<td></td>';
        allTablesHtml += '</tr>';

        // Player cards
        allTablesHtml += '<tr>';

        let hand1Html = '<td>';
        if  (player1.ph) {
            player1.ph.split('').forEach(cardValue => {
                hand1Html += `<img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:75px; margin:2px;">`;
            });
        } else {
            hand1Html += 'No cards';
        }
        hand1Html += '</td>';
        allTablesHtml += hand1Html;

        // Second player cards (if exists)
        if (player2) {
            let hand2Html = '<td>';
                if  (player2.ph) {
                player2.ph.split('').forEach(cardValue => {
                hand2Html += `<img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:75px; margin:2px;">`;
            }); 
            } else {
                hand2Html += 'No cards';
            }
            hand2Html += '</td>';
            allTablesHtml += hand2Html;
        } else {
            allTablesHtml += '<td></td>';
        }
        allTablesHtml += '</tr>';


    }

    allTablesHtml += '</table>';

}
container.innerHTML = allTablesHtml || '<p>No data available</p>';
        }

        // Fetch data when page loads
        fetchGameState();

 


    </script>
</body>
</html>        

