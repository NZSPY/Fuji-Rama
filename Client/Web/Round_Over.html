<!DOCTYPE html>
<html>
<head>
    <title>Game Results</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>

    <h2>Here are the results of the last round: 
        <button id="nextActionButton" style="margin: 10px;">Loading...</button>
    </h2>

    
    <div id="tableContainer"></div>
    
  <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const tableId = urlParams.get('table') || 'default'; // Use 'default' as fallback
        const playerName = urlParams.get('player') || 'unknown'; // Use 'unknown' as fallback
        function fetchGameState() {
            fetch(`http://192.168.68.100:8080/results?table=${tableId}&player=${playerName}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayTable(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    const container = document.getElementById('tableContainer');
                    container.innerHTML = `<p style="color: red;">Error loading data: ${error.message}</p>`;
                });
        
            }
            function updateButton(msg1,msg2) {
            const button = document.getElementById('nextActionButton');
            if (msg2 != "") {
                button.onclick = () => window.location.href = 'index.html';
                button.textContent = 'Start a New Game';
            } else {
                button.onclick = () => window.location.href = 'Play_Game.html?table=' + tableId + '&player=' + playerName;
                button.textContent = 'Play Next Round';
            }
        }



        function displayTable(data) {
            const container = document.getElementById('tableContainer');
            if (!data || typeof data !== 'object') {
                container.innerHTML = '<p style="color: red;">Invalid data received</p>';
                return;
            }
            
            let allTablesHtml = '';


// List of Players and their scores
if (data.pls) {
    allTablesHtml += '<table style="width: auto;">';
    const players = Array.isArray(data.pls) ? data.pls : [data.pls];
    const message1 = Array.isArray(data.msg1) ? data.msg1 : [data.msg1];
    const message2 = Array.isArray(data.msg2) ? data.msg2 : [data.msg2];
    const message3 = Array.isArray(data.msg3) ? data.msg3 : [data.msg3];
   
   updateButton(message1,message2);
    // Show message at top
    allTablesHtml += `<tr><th colspan="3">${message1}<br>${message2}<br>${message3}</th></tr>`;

    // Sort players by score in ascending order
    const sortedPlayers = [...players].sort((a, b) => (a.s || 0) - (b.s || 0));

    // Add leaderboard
    allTablesHtml += '<tr><th colspan="3" style="text-align: center;">Leaderboard</th></tr>';
    allTablesHtml += '<tr><th style="text-align: center;">Name</th><th style="text-align: center;">Current</th><th style="text-align: center;">Total</th></tr>';
    sortedPlayers.forEach((player, index) => {
        allTablesHtml += `<tr>
            <td>${player.n}</td>
            <td style="text-align: right">${player.rs || 0}</td>
            <td style="text-align: right"><b>${player.s || 0}</b></td>
        </tr>`;
    });
    allTablesHtml += '<table style="width: auto;">';
    // Find current player and other players
    const currentPlayer = players.find(p => p.n === playerName);
    const otherPlayers = players.filter(p => p.n !== playerName);

    // Show current player's info first
    if (currentPlayer) {
        allTablesHtml += `<tr><th colspan="2">${currentPlayer.n}'s cards are, ${currentPlayer.m1}</th></tr>`;
        let handHtml = '<td colspan="2">';
        if (Array.isArray(currentPlayer.ph)) {
            currentPlayer.ph.forEach(card => {
                const cardValue = typeof card === 'object' ? card.cv : card;
                handHtml += `<img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:100px; margin:2px;">`;
            });
        } else if (currentPlayer.ph) {
            handHtml += currentPlayer.ph;
        } else {
            handHtml += 'No cards';
        }
        handHtml += '</td>';
        allTablesHtml += `<tr>${handHtml}</tr>`;
       
    }
    allTablesHtml += '<tr><th colspan="2" style="text-align: center;">Other Players at the table</th></tr>';
    // Show other players in two columns
    for (let i = 0; i < otherPlayers.length; i += 2) {
        const player1 = otherPlayers[i];
        const player2 = otherPlayers[i + 1];

        // Player names
        allTablesHtml += '<tr>';
        allTablesHtml += `<td>${player1.n}'s cards are, ${player1.m1}<br>${player1.m2}</td>`;
        allTablesHtml += player2 ? `<td>${player2.n}'s cards are, ${player2.m1}<br>${player2.m2}</td>` : '<td></td>';
        allTablesHtml += '</tr>';

        // Player cards
        allTablesHtml += '<tr>';
        // First player cards
        let hand1Html = '<td>';
        if (Array.isArray(player1.ph)) {
            player1.ph.forEach(card => {
                const cardValue = typeof card === 'object' ? card.cv : card;
                hand1Html += `<img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:75px; margin:2px;">`;
            });
        } else if (player1.ph) {
            hand1Html += player1.ph;
        } else {
            hand1Html += 'No cards';
        }
        hand1Html += '</td>';
        allTablesHtml += hand1Html;

        // Second player cards (if exists)
        if (player2) {
            let hand2Html = '<td>';
            if (Array.isArray(player2.ph)) {
                player2.ph.forEach(card => {
                    const cardValue = typeof card === 'object' ? card.cv : card;
                    hand2Html += `<img src="LlamaCard${cardValue}.png" alt="Card ${cardValue}" style="width:75px; margin:2px;">`;
                });
            } else if (player2.ph) {
                hand2Html += player2.ph;
            } else {
                hand2Html += 'No cards';
            }
            hand2Html += '</td>';
            allTablesHtml += hand2Html;
        } else {
            allTablesHtml += '<td></td>';
        }
        allTablesHtml += '</tr>';


    }

    allTablesHtml += '</table>';

}
container.innerHTML = allTablesHtml || '<p>No data available</p>';
        }

        // Fetch data when page loads
        fetchGameState();

 


    </script>
</body>
</html>        

